@startuml activitydiagram

skinparam wrapWidth 80

start

:Create a copy of the data parameter (filtered_data). This is the data that will be returned to the user. Rows/columns will be removed from here as we iterate through each rule that applies to the passed organization;

:Filter the sharing rules parameter to only find the ones that apply to the passed organization parameter (org_rules);

:Create a variable which will hold the summary of the data removed for each rule. This should include the ID of the rule, the names of the table from where rows/columns were removed, the rows that were removed, and the names of the columns that were removed;

while (Iterate through each rule in org_rules)
    :Create a subset of filtered_data containing only the tables and columns that the current rule applies to (current_rule_data);

    :Create a variable (current_rule_summary) which will hold a summary of the data removed for the current rule;

    while (Iterate through all the values in the ruleValues column for the current rule)
        while (Iterate through each table in current_rule_data)
            if (The current rule's direction is **row**?) then (yes)
                while(Iterate through each row of the current table in current_rule_data)
                    if (Do any cells in the current row meets the current rule value's constraints (See the check_cell diagram)) then (yes)
                        :Add an entry in current_rule_summary for this row with this table;

                        :Remove this row from filtered_data;

                        :Remove rows from filtered_data which references the current removed row from filtered_data;
                    endif
                endwhile (no)
            elseif (The current rule's direction is **column**) then (yes)
                while (Iterate through each column of the current table in current_rule_data)
                    if (Do any cells in the current column meets this rule value's constraints (See the check_cell diagram)) then (yes)
                        :Add an entry in current_rule_summary for this column with this table;

                        :Remove this column from filtered_data;
                    endif
                endwhile
            else 
                :Throw an error informing the user about an unknown direction value;
            endif
        endwhile

        :Add the data from current_rule_summary to the master summary variable including the ID of the current rule;
    endwhile
endwhile

:Use the master summary variable to create the report object;

:Return the filtered_data and the report object;

stop

@enduml

